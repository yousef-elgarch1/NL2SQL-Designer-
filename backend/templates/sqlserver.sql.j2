-- SQL Server Database Schema
-- Generated by NL2SQL Designer
-- Database: {{ metadata.get('database_name', 'my_database') }}

{% if metadata.get('drop_existing', False) %}
-- Drop existing tables
{% for entity in entities %}
IF OBJECT_ID('[dbo].[{{ entity.name }}]', 'U') IS NOT NULL
    DROP TABLE [dbo].[{{ entity.name }}];
{% endfor %}

{% endif %}
-- Create tables
{% for entity in entities %}
CREATE TABLE [dbo].[{{ entity.name }}] (
{% for attr in entity.attributes %}
    [{{ attr.name }}] {{ attr.data_type }}{% if attr.length and attr.data_type in ['VARCHAR', 'CHAR', 'NVARCHAR', 'NCHAR'] %}({{ attr.length }}){% endif %}{% if attr.is_primary_key %} IDENTITY(1,1) PRIMARY KEY{% endif %}{% if not attr.is_nullable %} NOT NULL{% endif %}{% if attr.is_unique and not attr.is_primary_key %} UNIQUE{% endif %}{% if attr.default_value %} DEFAULT {{ attr.default_value }}{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
);

{% endfor %}

-- Add foreign key constraints
{% for rel in relationships %}
{% if rel.source_foreign_key %}
ALTER TABLE [dbo].[{{ rel.target_entity }}]
    ADD CONSTRAINT [FK_{{ rel.target_entity }}_{{ rel.source_entity }}]
    FOREIGN KEY ([{{ rel.source_foreign_key }}])
    REFERENCES [dbo].[{{ rel.source_entity }}]([id])
    ON DELETE CASCADE
    ON UPDATE CASCADE;

{% endif %}
{% endfor %}

-- Create indexes for better performance
{% for entity in entities %}
{% for attr in entity.attributes %}
{% if attr.is_foreign_key and not attr.is_primary_key %}
CREATE INDEX [IDX_{{ entity.name }}_{{ attr.name }}] ON [dbo].[{{ entity.name }}]([{{ attr.name }}]);
{% endif %}
{% endfor %}
{% endfor %}

-- End of SQL Server schema
