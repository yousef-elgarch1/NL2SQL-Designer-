-- Oracle Database Schema
-- Generated by NL2SQL Designer
-- Database: {{ metadata.get('database_name', 'my_database') }}

{% if metadata.get('drop_existing', False) %}
-- Drop existing tables
{% for entity in entities %}
BEGIN
    EXECUTE IMMEDIATE 'DROP TABLE "{{ entity.name }}" CASCADE CONSTRAINTS';
EXCEPTION
    WHEN OTHERS THEN NULL;
END;
/
{% endfor %}

{% endif %}
-- Create tables
{% for entity in entities %}
CREATE TABLE "{{ entity.name }}" (
{% for attr in entity.attributes %}
    "{{ attr.name }}" {{ attr.data_type }}{% if attr.length and attr.data_type in ['VARCHAR2', 'CHAR', 'NVARCHAR2'] %}({{ attr.length }}){% endif %}{% if not attr.is_nullable %} NOT NULL{% endif %}{% if attr.is_unique and not attr.is_primary_key %} UNIQUE{% endif %}{% if attr.default_value %} DEFAULT {{ attr.default_value }}{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}{% if entity.attributes | selectattr('is_primary_key') | list | length > 0 %},
    CONSTRAINT "PK_{{ entity.name }}" PRIMARY KEY ({% for attr in entity.attributes %}{% if attr.is_primary_key %}"{{ attr.name }}"{% if not loop.last %}, {% endif %}{% endif %}{% endfor %})
{% endif %}
);

{% endfor %}

-- Create sequences for primary keys
{% for entity in entities %}
{% for attr in entity.attributes %}
{% if attr.is_primary_key %}
CREATE SEQUENCE "SEQ_{{ entity.name }}_{{ attr.name }}"
    START WITH 1
    INCREMENT BY 1
    NOCACHE
    NOCYCLE;

{% endif %}
{% endfor %}
{% endfor %}

-- Create triggers for auto-increment
{% for entity in entities %}
{% for attr in entity.attributes %}
{% if attr.is_primary_key %}
CREATE OR REPLACE TRIGGER "TRG_{{ entity.name }}_{{ attr.name }}"
BEFORE INSERT ON "{{ entity.name }}"
FOR EACH ROW
BEGIN
    IF :NEW."{{ attr.name }}" IS NULL THEN
        SELECT "SEQ_{{ entity.name }}_{{ attr.name }}".NEXTVAL INTO :NEW."{{ attr.name }}" FROM DUAL;
    END IF;
END;
/

{% endif %}
{% endfor %}
{% endfor %}

-- Add foreign key constraints
{% for rel in relationships %}
{% if rel.source_foreign_key %}
ALTER TABLE "{{ rel.target_entity }}"
    ADD CONSTRAINT "FK_{{ rel.target_entity }}_{{ rel.source_entity }}"
    FOREIGN KEY ("{{ rel.source_foreign_key }}")
    REFERENCES "{{ rel.source_entity }}"("id")
    ON DELETE CASCADE;

{% endif %}
{% endfor %}

-- Create indexes for better performance
{% for entity in entities %}
{% for attr in entity.attributes %}
{% if attr.is_foreign_key and not attr.is_primary_key %}
CREATE INDEX "IDX_{{ entity.name }}_{{ attr.name }}" ON "{{ entity.name }}"("{{ attr.name }}");
{% endif %}
{% endfor %}
{% endfor %}

-- End of Oracle schema
