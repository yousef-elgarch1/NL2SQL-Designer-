-- MySQL Database Schema
-- Generated by NL2SQL Designer
-- Database: {{ metadata.get('database_name', 'my_database') }}

{% if metadata.get('drop_existing', False) %}
-- Drop existing tables
SET FOREIGN_KEY_CHECKS = 0;
{% for entity in entities %}
DROP TABLE IF EXISTS `{{ entity.name }}`;
{% endfor %}
SET FOREIGN_KEY_CHECKS = 1;

{% endif %}
-- Create tables
{% for entity in entities %}
CREATE TABLE `{{ entity.name }}` (
{% for attr in entity.attributes %}
    `{{ attr.name }}` {{ attr.data_type }}{% if attr.length and attr.data_type in ['VARCHAR', 'CHAR'] %}({{ attr.length }}){% endif %}{% if attr.is_primary_key %} PRIMARY KEY AUTO_INCREMENT{% endif %}{% if not attr.is_nullable %} NOT NULL{% endif %}{% if attr.is_unique and not attr.is_primary_key %} UNIQUE{% endif %}{% if attr.default_value %} DEFAULT {{ attr.default_value }}{% endif %}{% if not loop.last %},{% endif %}

{% endfor %}
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;

{% endfor %}

-- Add foreign key constraints
{% for rel in relationships %}
{% if rel.source_foreign_key %}
ALTER TABLE `{{ rel.target_entity }}`
    ADD CONSTRAINT `fk_{{ rel.target_entity }}_{{ rel.source_entity }}`
    FOREIGN KEY (`{{ rel.source_foreign_key }}`)
    REFERENCES `{{ rel.source_entity }}`(`id`)
    ON DELETE CASCADE
    ON UPDATE CASCADE;

{% endif %}
{% endfor %}

-- Create indexes for better performance
{% for entity in entities %}
{% for attr in entity.attributes %}
{% if attr.is_foreign_key and not attr.is_primary_key %}
CREATE INDEX `idx_{{ entity.name }}_{{ attr.name }}` ON `{{ entity.name }}`(`{{ attr.name }}`);
{% endif %}
{% endfor %}
{% endfor %}

-- End of MySQL schema
