{# PostgreSQL SQL Template #}
{# Generated by NL2SQL Generator #}

-- =====================================================
-- Database Schema: {{ metadata.get('schema_name', 'Generated Schema') }}
-- Generated: {{ metadata.get('timestamp', 'N/A') }}
-- DBMS: PostgreSQL
-- =====================================================

{% if options.get('include_comments', True) %}
-- Total Tables: {{ entities|length }}
-- Total Relationships: {{ relationships|length }}
{% endif %}

-- =====================================================
-- CREATE TABLES
-- =====================================================

{% for entity in entities %}
{% if options.get('include_comments', True) %}
-- Table: {{ entity.name }}
{% if entity.description %}
-- {{ entity.description }}
{% endif %}
{% endif %}
CREATE TABLE {{ entity.name.lower() }} (
    {%- for attr in entity.attributes %}
    {{ attr.name.lower() }} {{ attr.data_type }}{% if attr.length %}({{ attr.length }}){% endif %}
    {%- if attr.is_primary_key %} PRIMARY KEY{% endif %}
    {%- if not attr.is_nullable and not attr.is_primary_key %} NOT NULL{% endif %}
    {%- if attr.is_unique and not attr.is_primary_key %} UNIQUE{% endif %}
    {%- if attr.default_value %} DEFAULT {{ attr.default_value }}{% endif %}
    {%- if not loop.last %},{% endif %}
    {% endfor %}
);

{% endfor %}

{% if options.get('add_constraints', True) %}
-- =====================================================
-- FOREIGN KEY CONSTRAINTS
-- =====================================================

{% for rel in relationships %}
-- Relationship: {{ rel.name }} ({{ rel.source_entity }} -> {{ rel.target_entity }})
ALTER TABLE {{ rel.source_entity.lower() }}
    ADD CONSTRAINT fk_{{ rel.source_entity.lower() }}_{{ rel.target_entity.lower() }}
    FOREIGN KEY ({{ rel.source_foreign_key.lower() }})
    REFERENCES {{ rel.target_entity.lower() }}(id)
    ON DELETE CASCADE;

{% endfor %}
{% endif %}

{% if options.get('add_indexes', True) %}
-- =====================================================
-- INDEXES
-- =====================================================

{% for rel in relationships %}
CREATE INDEX idx_{{ rel.source_entity.lower() }}_{{ rel.source_foreign_key.lower() }}
    ON {{ rel.source_entity.lower() }}({{ rel.source_foreign_key.lower() }});

{% endfor %}
{% endif %}

-- =====================================================
-- END OF SCRIPT
-- =====================================================
